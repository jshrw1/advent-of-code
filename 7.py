from functools import lru_cache


test = [
    ".......S.......",
    "...............",
    ".......^.......",
    "...............",
    "......^.^......",
    "...............",
    ".....^.^.^.....",
    "...............",
    "....^.^...^....",
    "...............",
    "...^.^...^.^...",
    "...............",
    "..^...^.....^..",
    "...............",
    ".^.^.^.^.^...^.",
    "...............",
]

valid = [
    "......................................................................S......................................................................",
    ".............................................................................................................................................",
    "......................................................................^......................................................................",
    ".............................................................................................................................................",
    ".....................................................................^.^.....................................................................",
    ".............................................................................................................................................",
    "....................................................................^.^.^....................................................................",
    ".............................................................................................................................................",
    "...................................................................^.^...^...................................................................",
    ".............................................................................................................................................",
    "..................................................................^...^.^.^..................................................................",
    ".............................................................................................................................................",
    ".................................................................^.^...^.^.^.................................................................",
    ".............................................................................................................................................",
    "................................................................^...^.^.^.^.^................................................................",
    ".............................................................................................................................................",
    "...............................................................^.............^...............................................................",
    ".............................................................................................................................................",
    "..............................................................^...^.^.^...^.^.^..............................................................",
    ".............................................................................................................................................",
    ".............................................................^.^.^...^.....^.^.^.............................................................",
    ".............................................................................................................................................",
    "............................................................^...^.^.^...^.^...^.^............................................................",
    ".............................................................................................................................................",
    "...........................................................^.^...^.^...^.^.^...^.^...........................................................",
    ".............................................................................................................................................",
    "..........................................................^.^.^.^...^...^...^.....^..........................................................",
    ".............................................................................................................................................",
    ".........................................................^.^.^.....^.^.^.^...^.....^.........................................................",
    ".............................................................................................................................................",
    "........................................................^.^.^.^.^.......^...^.^.^...^........................................................",
    ".............................................................................................................................................",
    ".......................................................^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.......................................................",
    ".............................................................................................................................................",
    "......................................................^.....^...^.^.^...........^...^.^......................................................",
    ".............................................................................................................................................",
    ".....................................................^...^.^.^.^...^.....^.^.^...^...^.^.....................................................",
    ".............................................................................................................................................",
    "....................................................^.....^.^.^.^.....^.^.^.^.^.^...^.^.^....................................................",
    ".............................................................................................................................................",
    "...................................................^...^.^.^.^.^.^.^...^.^.^.^...^.^.^.^.^...................................................",
    ".............................................................................................................................................",
    "..................................................^.^.^.^.^...^.^...^.^...^.^.^.^.^.^...^.^..................................................",
    ".............................................................................................................................................",
    ".................................................^...^.....^...^.^.^.^...^.....^.^...^.^...^.................................................",
    ".............................................................................................................................................",
    "................................................^.^.^.....^.^.^.^.....^.^.^.^...^.....^.^.^.^................................................",
    ".............................................................................................................................................",
    "...............................................^.....^.......^.....^...^.^...^.^.^...^.......^...............................................",
    ".............................................................................................................................................",
    "..............................................^.^...^...^.^...^...^...^.^...^.^.^.^...^...^.^.^..............................................",
    ".............................................................................................................................................",
    ".............................................^...^...^.^.........^.^...^.^.....^.^.^.^.^.^...^.^.............................................",
    ".............................................................................................................................................",
    "............................................^.^.^...^.^.^.^.^...^.^.^...^.^...^.^...^.^.^.^.^.^.^............................................",
    ".............................................................................................................................................",
    "...........................................^.....^.........^.^.^.^.^.^.^...^.^.^...^.^.^.^...^...^...........................................",
    ".............................................................................................................................................",
    "..........................................^.^.^.....^.......^.^...^.^.^.^.^.^.....^...^.^.^.^.^...^..........................................",
    ".............................................................................................................................................",
    ".........................................^.^.^.^.^...^.^.....^.....^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.........................................",
    ".............................................................................................................................................",
    "........................................^.^.^...^...^.^.^.^.^.^.^.^...^...^...^.^...^.^...^...^.....^........................................",
    ".............................................................................................................................................",
    ".......................................^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.....^.^.^.^.^.^.^.........^.^.......................................",
    ".............................................................................................................................................",
    "......................................^.^.^.^.^.^.^.^.^.^.^...^.....^.......^.^.^.^.^.^.^.^...^...^...^......................................",
    ".............................................................................................................................................",
    ".....................................^.^.^.^.^...^...^.^.......^...^.^.....^...^.^.^.^.^.....^.^.^.^.^.^.....................................",
    ".............................................................................................................................................",
    "....................................^.....^.^...^...^.^.^.^.^.^...^.^.^...^.^.^.^.....^...^.^.^.^.^.^...^....................................",
    ".............................................................................................................................................",
    "...................................^.....^.^.........^...^.^.^.^.^.^.^...^.^.^...^.^.^.^.^...^.^...^.^...^...................................",
    ".............................................................................................................................................",
    "..................................^.^.^.^...^.^.^.^.^...^.^...^.^.^.^.^.....^.^.^.^.^.....^...^.....^.^.^.^..................................",
    ".............................................................................................................................................",
    ".................................^.^.........^...^.....^.^...^.^...^.^.^...^.^...^...^.^...^.^.^.^.^.....^.^.................................",
    ".............................................................................................................................................",
    "................................^.^...^.^.^.^.^...^...^...............^.....^.....^.^.^.^.^.^.^.^.^.^.....^.^................................",
    ".............................................................................................................................................",
    "...............................^.^.^...^.^...^.^.^...^...^.^.....^.^.^...^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^...............................",
    ".............................................................................................................................................",
    "..............................^...^.^.^.^.^.^.....^.^.^.^.....^.......^.^.^.^.^...^.^.^.^...^...^...^.^.^.....^..............................",
    ".............................................................................................................................................",
    ".............................^.^.^...^.^.^.^.^.^...^...^.^.^.^.^.^...^.^.^.^.^.......^.^.^.^...^.^.^.^...^.^...^.............................",
    ".............................................................................................................................................",
    "............................^.....^.^...^.^...^.^.....^.^...^.......^...^.^.....^...^.^...^...^.^.^.....^.^.....^............................",
    ".............................................................................................................................................",
    "...........................^...^...^...^.^.......^.....^.^.....^.^.^.^.^...^.^.^.^.....^.^.^...^.^.^.....^...^...^...........................",
    ".............................................................................................................................................",
    "..........................^.....^.^.^.......^.^...^.^.^.^.^.^.^.^.^.^.....^.....^.^...^.^...^.^.^...^...^.^.^.^...^..........................",
    ".............................................................................................................................................",
    ".........................^.^.^.^.^.^.^.^.^.^...^.....^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.^...^.^...^.^.^.^.^.........................",
    ".............................................................................................................................................",
    "........................^.^.^...^.^.^...^.^...^.........^.^.^...^.^.^.^.....^.^...^.^.^.^.^...^.^.^...^.^.....^.....^........................",
    ".............................................................................................................................................",
    ".......................^.^.^.^...^.^.....^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^...^.^.....^.......^.^.^.^...^.^...^.......................",
    ".............................................................................................................................................",
    "......................^.^...^.^.^.^.....^.^.^.^.^.....^.^...^.^.^.^.^.^.^...^...^.^.^.^...^.....^.^...^.^.^.^.^.^.^.^.^......................",
    ".............................................................................................................................................",
    ".....................^.^.^.^.^...^.^...^...^.^...^.^...^.^...^.......^.^.^.^.....^.^...^.^.^.^...^.^.^.^.^.^.^.^...^.^.^.....................",
    ".............................................................................................................................................",
    "....................^...^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.^.^.......^...^.....^.^...^...^.^.....^.^.^...^.^.^....................",
    ".............................................................................................................................................",
    "...................^.^.^.^.^.^.......^.^.^.......^...^.^.^.^...^.^.^...^.^.^.^...^.^.^.^.....^.^.^.^.^.^...^.^...^.....^.^...................",
    ".............................................................................................................................................",
    "..................^.^...^.......^.^.^.^.....^.^...^.^...^...^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.^...^.^.^...^..................",
    ".............................................................................................................................................",
    ".................^.....^.^...^...^.^.^.^...^.^.^.^...^.......^.^...^...^.^.^.....^.^.^...^.^...^.....^.^...^.^.^.^.^.^.^.^.^.................",
    ".............................................................................................................................................",
    "................^.^.^.....^.^.^.^.^.^.^.......^.^.^.....^...^.^...^.^.^.^.^...^.^...^.^.^...^...^.^.^.^...^.^.^.^...^.^.....^................",
    ".............................................................................................................................................",
    "...............^...^.^.^.^.^.^...^.^...^...^.^.^.^.^.^.^...^...^.^...............^...^.^.^.^.....^.....^.^.^.^.....^.^...^.^.^...............",
    ".............................................................................................................................................",
    "..............^.^...^.^.^.........^.........^...^.^.^.....^.^...^.^.^.^.^.^...^...^.^...^.^.^.^.......^.^...^.....^.^.^.^.^.^.^..............",
    ".............................................................................................................................................",
    ".............^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.....^.^.^.^...^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.............",
    ".............................................................................................................................................",
    "............^.^.^.^...^.^.^.^.^...^...^.....^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^...^.^.^...^...^.....^.^...^.^.^.^.^.......^...^............",
    ".............................................................................................................................................",
    "...........^.....^.^.^.^.....^.^...^.^.^.^.^.....^.^.^...^.^.^...^.^.....^.......^.^.^.....^.^.^.^...^.^.^.^.^.^.^.^.^.^...^...^.^...........",
    ".............................................................................................................................................",
    "..........^.^.^.^.........^.^.....^.......^.^...^.^.^.......^.......^.^.^.^.....^.^...^.^...^.^.^.^...^...^.^.^.^.^.^.^...^.^.^.^.^..........",
    ".............................................................................................................................................",
    ".........^.^.^...^.^.........^...^.^...^.^.^.^.^.^.^.^.....^.^.^.^...^.^.^...^...^...^.^.^.^.^.^.^.^.^.^.^...^.^...^.^...^.^.^...^.^.........",
    ".............................................................................................................................................",
    "........^.^.^.^.^...^.^...^.^.^.^...^.^.^.^.^.....^...^...^.^...^.^...^.^.^.^...^...^.^...^.......^.^.^.^...^.....^...^.^.^.....^.^.^........",
    ".............................................................................................................................................",
    ".......^.^.^...^.^.^.....^.^.^.^.....^.....^.^...^.^.^.....^.^...^...........^...^.^.^.^.....^...^.^.^...^.^.^.^.......^.^.^.^.^.....^.......",
    ".............................................................................................................................................",
    "......^.^...^.....^.^...^.....^...^...^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^...^.^.^...^.^.^.^.^.^.^.^...^.....^.^.....^.^.^.^.^...^...^.^......",
    ".............................................................................................................................................",
    ".....^.^.^.^.^.^...^.^.......^.^.^...^...^.^.^.^.^.^.^.....^.^.....^...^.....^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...^...^.^.^...^.^.....",
    ".............................................................................................................................................",
    "....^.^.^.....^.^...^.^...^.^.......^...^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.....^.^...^...^.^.^.^.^.^.^....",
    ".............................................................................................................................................",
    "...^.^.......^.^.....^.^.^.^.^...^.^...^.^.^.^.^.^.^.^.^.^.^...^...^.^.^.^.^.....^.^.^...^.^.^...^...^.^.^...^...^.^.^.^...^.^...^.^...^.^...",
    ".............................................................................................................................................",
    "..^.....^.^.^...^.........^.....^...^.^.^...^.^.....^...^.^.^.^.^.^...^.........^...^.^...^...^.^...^...^.......^.^.....^.^.......^.^.^...^..",
    ".............................................................................................................................................",
    ".^.^...^.....^.^.^.^...^.^.....^.^.^.^.^.^.^.^...^...^.^.......^.^...^.^.....^.^.^...^.....^.^.^.^.^.^.......^.^.^...^.^.^.^.^...^...^.^.^.^.",
    ".............................................................................................................................................",
]

rows = len(valid)
cols = len(valid[0])

beam = []
for r, row in enumerate(valid):
    c = row.find("S")
    if c != -1:
        beam.append((r, c))

splitters = []
for r, row in enumerate(valid):
    for c, chtr in enumerate(row):
        if chtr == "^":
            splitters.append((r, c))

count = 0
visited = set()

while beam:
    new_beam = []
    for row, col in beam:
        if (row, col) in visited:
            continue
        visited.add((row, col))

        next_row = row + 1
        if next_row >= rows:
            continue

        if (next_row, col) in splitters:
            count += 1
            if col - 1 >= 0:
                new_beam.append((next_row, col - 1))
            if col + 1 < cols:
                new_beam.append((next_row, col + 1))
        else:
            new_beam.append((next_row, col))
    beam = new_beam

print(count)

rows = len(valid)
cols = len(valid[0])

for r, row in enumerate(valid):
    c = row.find("S")
    if c != -1:
        start = (r, c)
        break

splits = set()
for r, row in enumerate(valid):
    for c, ch in enumerate(row):
        if ch == "^":
            splits.add((r, c))


beam = []
for r, row in enumerate(valid):
    c = row.find("S")
    if c != -1:
        beam.append((r, c))

splitters = []
for r, row in enumerate(valid):
    for c, chtr in enumerate(row):
        if chtr == "^":
            splitters.append((r, c))


@lru_cache(None)
def explore(row, col):
    if col < 0 or col >= cols:
        return 0

    if row == rows - 1:
        return 1

    next_row = row + 1

    if (next_row, col) in splits:
        paths = 0
        paths += explore(next_row, col - 1)
        paths += explore(next_row, col + 1)
        return paths

    return explore(next_row, col)


total_paths = explore(*start)
print(total_paths)
